#!/bin/bash

config_git() {
  echo "Configuring git"
  rm -rf ~/.gitconfig
  mkdir -p ~/gitlab
  mkdir -p ~/github
  cp .gitconfig ~
}

install_ohmyzsh() {
  echo "Installing oh-my-zsh..."
  rm -rf ~/.oh-my-zsh
  git clone https://github.com/ohmyzsh/ohmyzsh.git ~/.oh-my-zsh
  cp .zshrc ~
}

install_homebrew() {
  echo "Installing homebrew"
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  brew bundle
}

install_neovim() {
  echo "Installing neovim..."
  rm -rf ~/.config/nvim
  mkdir -p ~/.config/nvim
  cp -R nvim ~/.config
}

install_tmux() {
  echo "Installing tmux..."
  cp .tmux.conf ~
  rm -rf ~/.tmux/plugins/tpm
  git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
}


gpg_list_public_keys() {
  echo "Listing public GPG keys"
  gpg --list-keys
}

gpg_list_secret_keys() {
  echo "Listing secret GPG keys"
  gpg --list-secret-keys
}

gpg_import_public_key() {
  local file_path="$1"

  if [ -z "$file_path" ]; then
    echo "Usage: $0 gpg import-public-key /path/to/file"
    exit 1
  fi

  if [ ! -f "$file_path" ]; then
    echo "Error: File '$file_path' not found!"
    exit 1
  fi
  echo "Decrypting public key from $file_path"
  gpg -o public.key -d $file_path
  echo "Importing public key..."
  gpg --import public.key
  echo "Deleting generated public.key file"
  rm public.key
}

# Centralized configuration for git-secret managed files
# Format: "source_path:destination_path:is_symlink"
# is_symlink: true = create symbolic link, false = copy file
declare -a GIT_SECRET_FILES=(
  "flywire/.aws:~/.aws:true"
  "flywire/.extended-routes:~/.extended-routes:true"
  "flywire/.tokens.sh:~/.tokens.sh:true"
  "flywire/.aliases.sh:~/.aliases.sh:true"
  ".ssh/id_rsa:~/.ssh/id_rsa:false"
  ".ssh/id_rsa.pub:~/.ssh/id_rsa.pub:false"
)

gpg_import_secret_key() {
  local file_path="$1"

  if [ -z "$file_path" ]; then
    echo "Usage: $0 gpg import-secret-key /path/to/file"
    exit 1
  fi

  if [ ! -f "$file_path" ]; then
    echo "Error: File '$file_path' not found!"
    exit 1
  fi
  echo "Decrypting private key from $file_path"
  gpg -o private.key -d $file_path
  echo "Importing private key..."
  gpg --allow-secret-key-import --import private.key
  echo "Trusting the Key, please type trust, choose 5 and save"
  gpg --edit-key 3AE6F45129EAD69FEC607F7D4E29B67BD34C1F16
  echo "Deleting generated private.key file"
  rm private.key
}

git_secret_add() {
  echo "TODO"
}

: '
Requires: setup gpg import-public-key, setup gpg import-secret-key
Description: Reveal encrypted files for editing.
'
git_secret_reveal() {
  echo "Revealing all encrypted files for editing"
  git-secret reveal -f

  echo "Files decrypted and ready for editing:"
  for entry in "${GIT_SECRET_FILES[@]}"; do
    IFS=':' read -r source_path dest_path is_symlink <<< "$entry"

    if [ -f "$source_path" ]; then
      echo "  ✓ $source_path"
    fi
  done

  echo ""
  echo "After editing, run: setup git-secret update"
}

: '
Requires: setup gpg import-public-key, setup gpg import-secret-key
Description: Re-encrypt all files after updating and clean up decrypted files.
'
git_secret_update() {
  echo "Re-encrypting all files after updating"
  git-secret hide

  echo "Cleaning up decrypted files to leave no traces"
  for entry in "${GIT_SECRET_FILES[@]}"; do
    IFS=':' read -r source_path dest_path is_symlink <<< "$entry"

    if [ -f "$source_path" ]; then
      echo "  Removing decrypted file: $source_path"
      rm -f "$source_path"
    fi
  done

  echo "Cleanup complete - no unencrypted files remaining"
}

: '
Requires: setup gpg import-public-key, setup gpg import-secret-key
Description: Link decrypted files for working directory. Also configures ssh.
'
git_secret_copy() {
  echo "Decrypt all hidden files"
  git-secret reveal

  echo "Setting up decrypted files using centralized configuration"
  for entry in "${GIT_SECRET_FILES[@]}"; do
    IFS=':' read -r source_path dest_path is_symlink <<< "$entry"

    # Expand tilde in destination path
    dest_path="${dest_path/#\~/$HOME}"

    # Create parent directory if it doesn't exist
    dest_dir=$(dirname "$dest_path")
    mkdir -p "$dest_dir"

    if [ "$is_symlink" = "true" ]; then
      echo "  Creating symlink: $dest_path -> $(pwd)/$source_path"
      ln -s -f "$(pwd)/$source_path" "$dest_path"
    else
      echo "  Copying file: $source_path -> $dest_path"
      cp "$source_path" "$dest_path"

      # Special handling for SSH private keys
      if [[ "$dest_path" == *"/.ssh/id_rsa" ]]; then
        chmod 0600 "$dest_path"
        echo "    Set permissions 0600 on $dest_path"
      fi
    fi
  done

  echo "Decrypted files setup complete"
}

: '
Requires: openssh, pass, setup git-secret copy
Description: Install pass and configures the password store to my private github repository of password.
'
install_pass() {
  echo "Installing pass"
  rm -rf ~/github/pass
  mkdir -p ~/github/pass
  git clone git@github.com:jollopre/pass.git ~/github/pass
  ln -s -f ~/github/pass ~/.password-store
}

usage() {
    echo "Usage: $0 <command> [subcommand]"
    echo "Commands:"
    echo "  config-git            Configure git"
    echo "  install-ohmyzsh       Install OhMyZSH"
    echo "  install-homebrew      Install homebrew"
    echo "  install-neovim        Install neovim"
    echo "  install-tmux          Install tmux"
    echo "  gpg                   GPG"
    echo "    ├── list-public-keys      List public GPG keys"
    echo "    ├── list-secret-keys      List secret GPG keys"
    echo "    ├── import-public-key     Import public GPG key"
    echo "    ├── import-secret-key     Import secret GPG key"
    echo "  git-secret            git-secret"
    echo "    ├── add                   Add file for encrypting (TODO)"
    echo "    ├── reveal                Decrypt files for editing"
    echo "    ├── update                Re-encrypt files and cleanup decrypted versions"
    echo "    ├── copy                  Decrypt and setup secrets in \"$HOME\""
    echo "  install-pass          Install pass"
    echo "  help                  Display this help message"
    exit 1
}

case "$1" in
  config-git)
    config_git
    ;;
  install-ohmyzsh)
    install_ohmyzsh
    ;;
  install-homebrew)
    install_homebrew
    ;;
  install-neovim)
    install_neovim
    ;;
  install-tmux)
    install_tmux
    ;;
  gpg)
    case "$2" in
      list-public-keys)
        gpg_list_public_keys
        ;;
      list-secret-keys)
        gpg_list_secret_keys
        ;;
      import-public-key)
        gpg_import_public_key "$3"
        ;;
      import-secret-key)
        gpg_import_secret_key "$3"
        ;;
      *)
        echo "Invalid subcommand for gpg"
        usage
        ;;
    esac
    ;;
  git-secret)
    case "$2" in
      add)
        git_secret_add
        ;;
      reveal)
        git_secret_reveal
        ;;
      update)
        git_secret_update
        ;;
      copy)
        git_secret_copy
        ;;
      *)
        echo "Invalid subcommand for git-secret"
        usage
        ;;
    esac
    ;;
  install-pass)
    install_pass
    ;;
  help|*)
    usage
    ;;
esac
